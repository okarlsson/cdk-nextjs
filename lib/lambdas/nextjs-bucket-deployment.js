"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
/* eslint-disable import/no-extraneous-dependencies */
const node_fs_1 = require("node:fs");
const node_os_1 = require("node:os");
const node_path_1 = require("node:path");
const node_stream_1 = require("node:stream");
const client_s3_1 = require("@aws-sdk/client-s3");
// @ts-ignore jsii doesn't support esModuleInterop
// eslint-disable-next-line no-duplicate-imports
const jszip_1 = require("jszip");
const micromatch = require("micromatch");
const mime = require("mime-types");
const JSZip = jszip_1.default;
const s3 = new client_s3_1.S3Client({});
const handler = async (event, context) => {
    debug({ event });
    let responseStatus = 'SUCCESS';
    try {
        if (event.RequestType === 'Create' || event.RequestType === 'Update') {
            const props = getProperties(event);
            let tmpDir = '';
            const { assetsTmpDir, sourceDirPath, sourceZipFilePath } = initDirectories();
            tmpDir = assetsTmpDir;
            debug('Downloading zip');
            await downloadFile({
                bucket: props.sourceBucketName,
                key: props.sourceKeyPrefix,
                localDestinationPath: sourceZipFilePath,
            });
            debug('Extracting zip');
            await extractZip({ sourceZipFilePath, destinationDirPath: sourceDirPath });
            const filePaths = listFilePaths(sourceDirPath);
            if (props.substitutionConfig && Object.keys(props.substitutionConfig).length) {
                console.log('Replacing environment variables: ' + JSON.stringify(props.substitutionConfig));
                substitute({ config: props.substitutionConfig, filePaths });
            }
            if (props.prune) {
                debug('Emptying/pruning bucket: ' + props.destinationBucketName);
                await pruneBucket({ bucketName: props.destinationBucketName, keyPrefix: props.destinationKeyPrefix });
            }
            if (!props.zip) {
                debug('Uploading objects to: ' + props.destinationBucketName);
                await uploadObjects({
                    bucket: props.destinationBucketName,
                    keyPrefix: props.destinationKeyPrefix,
                    filePaths,
                    tmpDir: sourceDirPath,
                    putConfig: props.putConfig,
                });
            }
            else {
                debug('Uploading zip to: ' + props.destinationBucketName);
                const zipBuffer = await zipObjects({ tmpDir: sourceDirPath });
                await uploadZip({
                    zipBuffer,
                    bucket: props.destinationBucketName,
                    keyPrefix: props.destinationKeyPrefix,
                });
            }
            if (tmpDir.length) {
                debug('Removing temp directory');
                (0, node_fs_1.rmSync)(tmpDir, { force: true, recursive: true });
            }
            responseStatus = 'SUCCESS';
        }
    }
    catch (err) {
        console.error(err);
        responseStatus = 'FAILED';
    }
    await cfnResponse({ event, context, responseStatus });
};
exports.handler = handler;
function debug(value) {
    if (process.env.DEBUG)
        console.log(JSON.stringify(value, null, 2));
}
function getProperties(event) {
    const props = event.ResourceProperties;
    return {
        ...props,
        prune: props.prune === 'true',
        zip: props.zip === 'true',
    };
}
function initDirectories() {
    const assetsTmpDir = (0, node_fs_1.mkdtempSync)((0, node_path_1.resolve)((0, node_os_1.tmpdir)(), 'assets-'));
    const sourceZipDirPath = (0, node_path_1.resolve)(assetsTmpDir, 'source-zip');
    (0, node_fs_1.mkdirSync)(sourceZipDirPath);
    const sourceZipFilePath = (0, node_path_1.resolve)(sourceZipDirPath, 'temp.zip');
    // trailing slash expected by adm-zip's `extractAllTo` method
    const sourceDirPath = (0, node_path_1.resolve)(assetsTmpDir, 'source') + '/';
    (0, node_fs_1.mkdirSync)(sourceDirPath);
    return { assetsTmpDir, sourceZipFilePath, sourceDirPath };
}
async function downloadFile({ bucket, key, localDestinationPath, }) {
    const data = await s3.send(new client_s3_1.GetObjectCommand({ Bucket: bucket, Key: key }));
    return new Promise(async (resolve, reject) => {
        const body = data.Body;
        if (body instanceof node_stream_1.Readable) {
            const writeStream = (0, node_fs_1.createWriteStream)(localDestinationPath);
            body
                .pipe(writeStream)
                .on('error', (err) => reject(err))
                .on('close', () => resolve(null));
        }
    });
}
async function extractZip({ sourceZipFilePath, destinationDirPath, }) {
    const zipBuffer = (0, node_fs_1.readFileSync)(sourceZipFilePath);
    const archive = await JSZip.loadAsync(zipBuffer);
    for (const [zipRelativePath, zipObject] of Object.entries(archive.files)) {
        if (!zipObject.dir) {
            const absPath = (0, node_path_1.resolve)(destinationDirPath, zipRelativePath);
            const pathDirname = (0, node_path_1.dirname)(absPath);
            if (!(0, node_fs_1.existsSync)(pathDirname)) {
                (0, node_fs_1.mkdirSync)(pathDirname, { recursive: true });
            }
            const fileContents = await zipObject.async('nodebuffer');
            let isSymLink = false;
            const unixPermissions = zipObject?.unixPermissions;
            if (typeof unixPermissions === 'number') {
                // https://github.com/twolfson/grunt-zip/pull/52/files
                // eslint-disable-next-line no-bitwise
                isSymLink = (unixPermissions & 0xf000) === 0xa000;
            }
            if (isSymLink) {
                (0, node_fs_1.symlinkSync)(fileContents, absPath);
            }
            else {
                (0, node_fs_1.writeFileSync)(absPath, fileContents);
            }
        }
    }
}
/**
 * Given path of directory, returns array of all file paths within directory
 */
function listFilePaths(dirPath) {
    const filePaths = [];
    const directory = (0, node_fs_1.readdirSync)(dirPath, { withFileTypes: true });
    for (const d of directory) {
        const filePath = (0, node_path_1.resolve)(dirPath, d.name);
        if (d.isDirectory()) {
            filePaths.push(...listFilePaths(filePath));
        }
        else {
            filePaths.push(filePath);
        }
    }
    return filePaths;
}
function substitute({ filePaths, config }) {
    const findRegExp = new RegExp(Object.keys(config).join('|'), 'g');
    for (const filePath of filePaths) {
        if (filePath.includes('node_modules'))
            continue;
        const fileContents = (0, node_fs_1.readFileSync)(filePath, { encoding: 'utf8' });
        const newFileContents = fileContents.replace(findRegExp, (matched) => {
            const matchedEnvVar = config[matched];
            if (matchedEnvVar) {
                return matchedEnvVar;
            }
            else {
                console.warn(`Could not find matched value: ${matched} in environment object. Substituting ''`);
                return '';
            }
        });
        if (fileContents !== newFileContents) {
            (0, node_fs_1.writeFileSync)(filePath, newFileContents);
        }
    }
}
async function pruneBucket({ bucketName, keyPrefix }) {
    const deleteObjectPromises = [];
    let numObjectsDeleted = 0;
    let nextToken = undefined;
    do {
        const cmd = { Bucket: bucketName, Prefix: keyPrefix };
        if (nextToken) {
            cmd.ContinuationToken = nextToken;
        }
        const res = await s3.send(new client_s3_1.ListObjectsV2Command(cmd));
        const contents = res.Contents;
        nextToken = res.NextContinuationToken;
        if (contents?.length) {
            const objects = contents?.map((o) => ({ Key: o.Key }));
            numObjectsDeleted += objects?.length;
            deleteObjectPromises.push(s3.send(new client_s3_1.DeleteObjectsCommand({
                Bucket: bucketName,
                Delete: { Objects: objects },
            })));
        }
    } while (nextToken);
    await Promise.all(deleteObjectPromises);
    console.log(`Number of objects deleted for bucket ${bucketName}: ${numObjectsDeleted}`);
}
function uploadObjects({ bucket, keyPrefix, filePaths, tmpDir, putConfig = {}, }) {
    const putObjectInputs = filePaths.map((path) => {
        const contentType = mime.lookup(path) || undefined;
        const putObjectOptions = getPutObjectOptions({ path, putConfig });
        const keyPaths = [];
        if (keyPrefix)
            keyPaths.push(keyPrefix);
        keyPaths.push((0, node_path_1.relative)(tmpDir, path));
        return {
            ContentType: contentType,
            ...putObjectOptions,
            Bucket: bucket,
            // .slice(1) to remove leading slash b/c s3 will create top level / folder
            Key: (0, node_path_1.join)(...keyPaths),
            Body: (0, node_fs_1.createReadStream)(path),
        };
    });
    return Promise.all(putObjectInputs.map((input) => s3.send(new client_s3_1.PutObjectCommand(input))));
}
/**
 * Zips objects taking into account symlinks
 * @see https://github.com/Stuk/jszip/issues/386#issuecomment-634773343
 */
function zipObjects({ tmpDir }) {
    const zip = new JSZip();
    const filePaths = listFilePaths(tmpDir);
    for (const filePath of filePaths) {
        const relativePath = (0, node_path_1.relative)(tmpDir, filePath);
        const stat = (0, node_fs_1.lstatSync)(filePath);
        if (stat.isSymbolicLink()) {
            zip.file(relativePath, (0, node_fs_1.readlinkSync)(filePath), {
                dir: stat.isDirectory(),
                unixPermissions: parseInt('120755', 8),
            });
        }
        else {
            zip.file(relativePath, (0, node_fs_1.readFileSync)(filePath), { dir: stat.isDirectory(), unixPermissions: stat.mode });
        }
    }
    return zip.generateAsync({
        type: 'nodebuffer',
        platform: 'UNIX',
        compression: 'STORE',
    });
}
async function uploadZip({ bucket, keyPrefix, zipBuffer, }) {
    return s3.send(new client_s3_1.PutObjectCommand({
        Bucket: bucket,
        Key: keyPrefix,
        Body: zipBuffer,
        ContentType: 'application/zip',
    }));
}
function getPutObjectOptions({ path, putConfig = {}, }) {
    let putObjectOptions = {};
    for (const [key, value] of Object.entries(putConfig)) {
        if (micromatch.isMatch(path, key)) {
            putObjectOptions = { ...putObjectOptions, ...value };
        }
    }
    return putObjectOptions;
}
/**
 * Inspired by: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-lambda-function-code-cfnresponsemodule.html
 */
function cfnResponse(props) {
    const body = JSON.stringify({
        Status: props.responseStatus,
        Reason: 'See the details in CloudWatch Log Stream: ' + props.context.logStreamName,
        PhysicalResourceId: props.physicalResourceId || props.context.logStreamName,
        StackId: props.event.StackId,
        RequestId: props.event.RequestId,
        LogicalResourceId: props.event.LogicalResourceId,
        Data: props.responseData,
    });
    return fetch(props.event.ResponseURL, {
        method: 'PUT',
        body,
        headers: { 'content-type': '', 'content-length': body.length.toString() },
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmV4dGpzLWJ1Y2tldC1kZXBsb3ltZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2xhbWJkYXMvbmV4dGpzLWJ1Y2tldC1kZXBsb3ltZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHNEQUFzRDtBQUN0RCxxQ0FhaUI7QUFDakIscUNBQWlDO0FBQ2pDLHlDQUE0RTtBQUM1RSw2Q0FBdUM7QUFDdkMsa0RBUTRCO0FBRzVCLGtEQUFrRDtBQUNsRCxnREFBZ0Q7QUFDaEQsaUNBQTJCO0FBQzNCLHlDQUF5QztBQUN6QyxtQ0FBbUM7QUFFbkMsTUFBTSxLQUFLLEdBQUcsZUFBbUIsQ0FBQztBQUVsQyxNQUFNLEVBQUUsR0FBRyxJQUFJLG9CQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7QUFFckIsTUFBTSxPQUFPLEdBQXdDLEtBQUssRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLEVBQUU7SUFDbkYsS0FBSyxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztJQUNqQixJQUFJLGNBQWMsR0FBeUIsU0FBUyxDQUFDO0lBQ3JELElBQUk7UUFDRixJQUFJLEtBQUssQ0FBQyxXQUFXLEtBQUssUUFBUSxJQUFJLEtBQUssQ0FBQyxXQUFXLEtBQUssUUFBUSxFQUFFO1lBQ3BFLE1BQU0sS0FBSyxHQUFHLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNuQyxJQUFJLE1BQU0sR0FBRyxFQUFFLENBQUM7WUFDaEIsTUFBTSxFQUFFLFlBQVksRUFBRSxhQUFhLEVBQUUsaUJBQWlCLEVBQUUsR0FBRyxlQUFlLEVBQUUsQ0FBQztZQUM3RSxNQUFNLEdBQUcsWUFBWSxDQUFDO1lBQ3RCLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1lBQ3pCLE1BQU0sWUFBWSxDQUFDO2dCQUNqQixNQUFNLEVBQUUsS0FBSyxDQUFDLGdCQUFnQjtnQkFDOUIsR0FBRyxFQUFFLEtBQUssQ0FBQyxlQUFlO2dCQUMxQixvQkFBb0IsRUFBRSxp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QWdCLENBQUM7QUFDMUIsQ0FBQztBQVNEOztHQUVHO0FBQ0gsU0FBUyxXQUFXLENBQUMsS0FBdUI7SUFDMUMsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztRQUMxQixNQUFNLEVBQUUsS0FBSyxDQUFDLGNBQWM7UUFDNUIsTUFBTSxFQUFFLDRDQUE0QyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsYUFBYTtRQUNsRixrQkFBa0IsRUFBRSxLQUFLLENBQUMsa0JBQWtCLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxhQUFhO1FBQzNFLE9BQU8sRUFBRSxLQUFLLENBQUMsS0FBSyxDQUFDLE9BQU87UUFDNUIsU0FBUyxFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUMsU0FBUztRQUNoQyxpQkFBaUIsRUFBRSxLQUFLLENBQUMsS0FBSyxDQUFDLGlCQUFpQjtRQUNoRCxJQUFJLEVBQUUsS0FBSyxDQUFDLFlBQVk7S0FDekIsQ0FBQyxDQUFDO0lBQ0gsT0FBTyxLQUFLLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUU7UUFDcEMsTUFBTSxFQUFFLEtBQUs7UUFDYixJQUFJO1FBQ0osT0FBTyxFQUFFLEVBQUUsY0FBYyxFQUFFLEVBQUUsRUFBRSxnQkFBZ0IsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxFQUFFO0tBQzFFLENBQUMsQ0FBQztBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBpbXBvcnQvbm8tZXh0cmFuZW91cy1kZXBlbmRlbmNpZXMgKi9cbmltcG9ydCB7XG4gIGNyZWF0ZVJlYWRTdHJlYW0sXG4gIGNyZWF0ZVdyaXRlU3RyZWFtLFxuICBleGlzdHNTeW5jLFxuICBsc3RhdFN5bmMsXG4gIG1rZGlyU3luYyxcbiAgbWtkdGVtcFN5bmMsXG4gIHJlYWRkaXJTeW5jLFxuICByZWFkRmlsZVN5bmMsXG4gIHJlYWRsaW5rU3luYyxcbiAgcm1TeW5jLFxuICBzeW1saW5rU3luYyxcbiAgd3JpdGVGaWxlU3luYyxcbn0gZnJvbSAnbm9kZTpmcyc7XG5pbXBvcnQgeyB0bXBkaXIgfSBmcm9tICdub2RlOm9zJztcbmltcG9ydCB7IGRpcm5hbWUsIGpvaW4sIHJlbGF0aXZlLCByZXNvbHZlIGFzIHJlc29sdmVQYXRoIH0gZnJvbSAnbm9kZTpwYXRoJztcbmltcG9ydCB7IFJlYWRhYmxlIH0gZnJvbSAnbm9kZTpzdHJlYW0nO1xuaW1wb3J0IHtcbiAgRGVsZXRlT2JqZWN0c0NvbW1hbmQsXG4gIEdldE9iamVjdENvbW1hbmQsXG4gIExpc3RPYmplY3RzVjJDb21tYW5kLFxuICB0eXBlIExpc3RPYmplY3RzVjJDb21tYW5kSW5wdXQsXG4gIFB1dE9iamVjdENvbW1hbmQsXG4gIHR5cGUgUHV0T2JqZWN0Q29tbWFuZElucHV0LFxuICBTM0NsaWVudCxcbn0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXMzJztcbmltcG9ydCB0eXBlIHsgQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZUhhbmRsZXIgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB0eXBlICogYXMgSlNaaXBUeXBlIGZyb20gJ2pzemlwJztcbi8vIEB0cy1pZ25vcmUganNpaSBkb2Vzbid0IHN1cHBvcnQgZXNNb2R1bGVJbnRlcm9wXG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tZHVwbGljYXRlLWltcG9ydHNcbmltcG9ydCBfSlNaaXAgZnJvbSAnanN6aXAnO1xuaW1wb3J0ICogYXMgbWljcm9tYXRjaCBmcm9tICdtaWNyb21hdGNoJztcbmltcG9ydCAqIGFzIG1pbWUgZnJvbSAnbWltZS10eXBlcyc7XG5pbXBvcnQgdHlwZSB7IEN1c3RvbVJlc291cmNlUHJvcGVydGllcywgTmV4dGpzQnVja2V0RGVwbG95bWVudFByb3BzIH0gZnJvbSAnLi4vTmV4dGpzQnVja2V0RGVwbG95bWVudCc7XG5jb25zdCBKU1ppcCA9IF9KU1ppcCBhcyBKU1ppcFR5cGU7XG5cbmNvbnN0IHMzID0gbmV3IFMzQ2xpZW50KHt9KTtcblxuZXhwb3J0IGNvbnN0IGhhbmRsZXI6IENsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VIYW5kbGVyID0gYXN5bmMgKGV2ZW50LCBjb250ZXh0KSA9PiB7XG4gIGRlYnVnKHsgZXZlbnQgfSk7XG4gIGxldCByZXNwb25zZVN0YXR1czogJ1NVQ0NFU1MnIHwgJ0ZBSUxFRCcgPSAnU1VDQ0VTUyc7XG4gIHRyeSB7XG4gICAgaWYgKGV2ZW50LlJlcXVlc3RUeXBlID09PSAnQ3JlYXRlJyB8fCBldmVudC5SZXF1ZXN0VHlwZSA9PT0gJ1VwZGF0ZScpIHtcbiAgICAgIGNvbnN0IHByb3BzID0gZ2V0UHJvcGVydGllcyhldmVudCk7XG4gICAgICBsZXQgdG1wRGlyID0gJyc7XG4gICAgICBjb25zdCB7IGFzc2V0c1RtcERpciwgc291cmNlRGlyUGF0aCwgc291cmNlWmlwRmlsZVBhdGggfSA9IGluaXREaXJlY3RvcmllcygpO1xuICAgICAgdG1wRGlyID0gYXNzZXRzVG1wRGlyO1xuICAgICAgZGVidWcoJ0Rvd25sb2FkaW5nIHppcCcpO1xuICAgICAgYXdhaXQgZG93bmxvYWRGaWxlKHtcbiAgICAgICAgYnVja2V0OiBwcm9wcy5zb3VyY2VCdWNrZXROYW1lLFxuICAgICAgICBrZXk6IHByb3BzLnNvdXJjZUtleVByZWZpeCxcbiAgICAgICAgbG9jYWxEZXN0aW5hdGlvblBhdGg6IHNvdXJjZVppcEZpbGVQYXRoLFxuICAgICAgfSk7XG4gICAgICBkZWJ1ZygnRXh0cmFjdGluZyB6aXAnKTtcbiAgICAgIGF3YWl0IGV4dHJhY3RaaXAoeyBzb3VyY2VaaXBGaWxlUGF0aCwgZGVzdGluYXRpb25EaXJQYXRoOiBzb3VyY2VEaXJQYXRoIH0pO1xuICAgICAgY29uc3QgZmlsZVBhdGhzID0gbGlzdEZpbGVQYXRocyhzb3VyY2VEaXJQYXRoKTtcbiAgICAgIGlmIChwcm9wcy5zdWJzdGl0dXRpb25Db25maWcgJiYgT2JqZWN0LmtleXMocHJvcHMuc3Vic3RpdHV0aW9uQ29uZmlnKS5sZW5ndGgpIHtcbiAgICAgICAgY29uc29sZS5sb2coJ1JlcGxhY2luZyBlbnZpcm9ubWVudCB2YXJpYWJsZXM6ICcgKyBKU09OLnN0cmluZ2lmeShwcm9wcy5zdWJzdGl0dXRpb25Db25maWcpKTtcbiAgICAgICAgc3Vic3RpdHV0ZSh7IGNvbmZpZzogcHJvcHMuc3Vic3RpdHV0aW9uQ29uZmlnLCBmaWxlUGF0aHMgfSk7XG4gICAgICB9XG4gICAgICBpZiAocHJvcHMucHJ1bmUpIHtcbiAgICAgICAgZGVidWcoJ0VtcHR5aW5nL3BydW5pbmcgYnVja2V0OiAnICsgcHJvcHMuZGVzdGluYXRpb25CdWNrZXROYW1lKTtcbiAgICAgICAgYXdhaXQgcHJ1bmVCdWNrZXQoeyBidWNrZXROYW1lOiBwcm9wcy5kZXN0aW5hdGlvbkJ1Y2tldE5hbWUsIGtleVByZWZpeDogcHJvcHMuZGVzdGluYXRpb25LZXlQcmVmaXggfSk7XG4gICAgICB9XG4gICAgICBpZiAoIXByb3BzLnppcCkge1xuICAgICAgICBkZWJ1ZygnVXBsb2FkaW5nIG9iamVjdHMgdG86ICcgKyBwcm9wcy5kZXN0aW5hdGlvbkJ1Y2tldE5hbWUpO1xuICAgICAgICBhd2FpdCB1cGxvYWRPYmplY3RzKHtcbiAgICAgICAgICBidWNrZXQ6IHByb3BzLmRlc3RpbmF0aW9uQnVja2V0TmFtZSxcbiAgICAgICAgICBrZXlQcmVmaXg6IHByb3BzLmRlc3RpbmF0aW9uS2V5UHJlZml4LFxuICAgICAgICAgIGZpbGVQYXRocyxcbiAgICAgICAgICB0bXBEaXI6IHNvdXJjZURpclBhdGgsXG4gICAgICAgICAgcHV0Q29uZmlnOiBwcm9wcy5wdXRDb25maWcsXG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZGVidWcoJ1VwbG9hZGluZyB6aXAgdG86ICcgKyBwcm9wcy5kZXN0aW5hdGlvbkJ1Y2tldE5hbWUpO1xuICAgICAgICBjb25zdCB6aXBCdWZmZXIgPSBhd2FpdCB6aXBPYmplY3RzKHsgdG1wRGlyOiBzb3VyY2VEaXJQYXRoIH0pO1xuICAgICAgICBhd2FpdCB1cGxvYWRaaXAoe1xuICAgICAgICAgIHppcEJ1ZmZlcixcbiAgICAgICAgICBidWNrZXQ6IHByb3BzLmRlc3RpbmF0aW9uQnVja2V0TmFtZSxcbiAgICAgICAgICBrZXlQcmVmaXg6IHByb3BzLmRlc3RpbmF0aW9uS2V5UHJlZml4LFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIGlmICh0bXBEaXIubGVuZ3RoKSB7XG4gICAgICAgIGRlYnVnKCdSZW1vdmluZyB0ZW1wIGRpcmVjdG9yeScpO1xuICAgICAgICBybVN5bmModG1wRGlyLCB7IGZvcmNlOiB0cnVlLCByZWN1cnNpdmU6IHRydWUgfSk7XG4gICAgICB9XG4gICAgICByZXNwb25zZVN0YXR1cyA9ICdTVUNDRVNTJztcbiAgICB9XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcbiAgICByZXNwb25zZVN0YXR1cyA9ICdGQUlMRUQnO1xuICB9XG4gIGF3YWl0IGNmblJlc3BvbnNlKHsgZXZlbnQsIGNvbnRleHQsIHJlc3BvbnNlU3RhdHVzIH0pO1xufTtcblxuZnVuY3Rpb24gZGVidWcodmFsdWU6IHVua25vd24pIHtcbiAgaWYgKHByb2Nlc3MuZW52LkRFQlVHKSBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeSh2YWx1ZSwgbnVsbCwgMikpO1xufVxuXG5mdW5jdGlvbiBnZXRQcm9wZXJ0aWVzKGV2ZW50OiBQYXJhbWV0ZXJzPENsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VIYW5kbGVyPlswXSkge1xuICBjb25zdCBwcm9wcyA9IGV2ZW50LlJlc291cmNlUHJvcGVydGllcztcbiAgcmV0dXJuIHtcbiAgICAuLi5wcm9wcyxcbiAgICBwcnVuZTogcHJvcHMucHJ1bmUgPT09ICd0cnVlJyxcbiAgICB6aXA6IHByb3BzLnppcCA9PT0gJ3RydWUnLFxuICB9IGFzIEN1c3RvbVJlc291cmNlUHJvcGVydGllcyAmIHsgU2VydmljZVRva2VuOiBzdHJpbmcgfTtcbn1cblxuZnVuY3Rpb24gaW5pdERpcmVjdG9yaWVzKCkge1xuICBjb25zdCBhc3NldHNUbXBEaXIgPSBta2R0ZW1wU3luYyhyZXNvbHZlUGF0aCh0bXBkaXIoKSwgJ2Fzc2V0cy0nKSk7XG4gIGNvbnN0IHNvdXJjZVppcERpclBhdGggPSByZXNvbHZlUGF0aChhc3NldHNUbXBEaXIsICdzb3VyY2UtemlwJyk7XG4gIG1rZGlyU3luYyhzb3VyY2VaaXBEaXJQYXRoKTtcbiAgY29uc3Qgc291cmNlWmlwRmlsZVBhdGggPSByZXNvbHZlUGF0aChzb3VyY2VaaXBEaXJQYXRoLCAndGVtcC56aXAnKTtcbiAgLy8gdHJhaWxpbmcgc2xhc2ggZXhwZWN0ZWQgYnkgYWRtLXppcCdzIGBleHRyYWN0QWxsVG9gIG1ldGhvZFxuICBjb25zdCBzb3VyY2VEaXJQYXRoID0gcmVzb2x2ZVBhdGgoYXNzZXRzVG1wRGlyLCAnc291cmNlJykgKyAnLyc7XG4gIG1rZGlyU3luYyhzb3VyY2VEaXJQYXRoKTtcbiAgcmV0dXJuIHsgYXNzZXRzVG1wRGlyLCBzb3VyY2VaaXBGaWxlUGF0aCwgc291cmNlRGlyUGF0aCB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBkb3dubG9hZEZpbGUoe1xuICBidWNrZXQsXG4gIGtleSxcbiAgbG9jYWxEZXN0aW5hdGlvblBhdGgsXG59OiB7XG4gIGJ1Y2tldDogc3RyaW5nO1xuICBrZXk/OiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIGxvY2FsRGVzdGluYXRpb25QYXRoOiBzdHJpbmc7XG59KSB7XG4gIGNvbnN0IGRhdGEgPSBhd2FpdCBzMy5zZW5kKG5ldyBHZXRPYmplY3RDb21tYW5kKHsgQnVja2V0OiBidWNrZXQsIEtleToga2V5IH0pKTtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKGFzeW5jIChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBjb25zdCBib2R5ID0gZGF0YS5Cb2R5O1xuICAgIGlmIChib2R5IGluc3RhbmNlb2YgUmVhZGFibGUpIHtcbiAgICAgIGNvbnN0IHdyaXRlU3RyZWFtID0gY3JlYXRlV3JpdGVTdHJlYW0obG9jYWxEZXN0aW5hdGlvblBhdGgpO1xuICAgICAgYm9keVxuICAgICAgICAucGlwZSh3cml0ZVN0cmVhbSlcbiAgICAgICAgLm9uKCdlcnJvcicsIChlcnIpID0+IHJlamVjdChlcnIpKVxuICAgICAgICAub24oJ2Nsb3NlJywgKCkgPT4gcmVzb2x2ZShudWxsKSk7XG4gICAgfVxuICB9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZXh0cmFjdFppcCh7XG4gIHNvdXJjZVppcEZpbGVQYXRoLFxuICBkZXN0aW5hdGlvbkRpclBhdGgsXG59OiB7XG4gIHNvdXJjZVppcEZpbGVQYXRoOiBzdHJpbmc7XG4gIGRlc3RpbmF0aW9uRGlyUGF0aDogc3RyaW5nO1xufSkge1xuICBjb25zdCB6aXBCdWZmZXIgPSByZWFkRmlsZVN5bmMoc291cmNlWmlwRmlsZVBhdGgpO1xuICBjb25zdCBhcmNoaXZlID0gYXdhaXQgSlNaaXAubG9hZEFzeW5jKHppcEJ1ZmZlcik7XG4gIGZvciAoY29uc3QgW3ppcFJlbGF0aXZlUGF0aCwgemlwT2JqZWN0XSBvZiBPYmplY3QuZW50cmllcyhhcmNoaXZlLmZpbGVzKSkge1xuICAgIGlmICghemlwT2JqZWN0LmRpcikge1xuICAgICAgY29uc3QgYWJzUGF0aCA9IHJlc29sdmVQYXRoKGRlc3RpbmF0aW9uRGlyUGF0aCwgemlwUmVsYXRpdmVQYXRoKTtcbiAgICAgIGNvbnN0IHBhdGhEaXJuYW1lID0gZGlybmFtZShhYnNQYXRoKTtcbiAgICAgIGlmICghZXhpc3RzU3luYyhwYXRoRGlybmFtZSkpIHtcbiAgICAgICAgbWtkaXJTeW5jKHBhdGhEaXJuYW1lLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGZpbGVDb250ZW50cyA9IGF3YWl0IHppcE9iamVjdC5hc3luYygnbm9kZWJ1ZmZlcicpO1xuICAgICAgbGV0IGlzU3ltTGluayA9IGZhbHNlO1xuICAgICAgY29uc3QgdW5peFBlcm1pc3Npb25zID0gemlwT2JqZWN0Py51bml4UGVybWlzc2lvbnM7XG4gICAgICBpZiAodHlwZW9mIHVuaXhQZXJtaXNzaW9ucyA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL3R3b2xmc29uL2dydW50LXppcC9wdWxsLzUyL2ZpbGVzXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1iaXR3aXNlXG4gICAgICAgIGlzU3ltTGluayA9ICh1bml4UGVybWlzc2lvbnMgJiAweGYwMDApID09PSAweGEwMDA7XG4gICAgICB9XG4gICAgICBpZiAoaXNTeW1MaW5rKSB7XG4gICAgICAgIHN5bWxpbmtTeW5jKGZpbGVDb250ZW50cywgYWJzUGF0aCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB3cml0ZUZpbGVTeW5jKGFic1BhdGgsIGZpbGVDb250ZW50cyk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogR2l2ZW4gcGF0aCBvZiBkaXJlY3RvcnksIHJldHVybnMgYXJyYXkgb2YgYWxsIGZpbGUgcGF0aHMgd2l0aGluIGRpcmVjdG9yeVxuICovXG5mdW5jdGlvbiBsaXN0RmlsZVBhdGhzKGRpclBhdGg6IHN0cmluZyk6IHN0cmluZ1tdIHtcbiAgY29uc3QgZmlsZVBhdGhzOiBzdHJpbmdbXSA9IFtdO1xuICBjb25zdCBkaXJlY3RvcnkgPSByZWFkZGlyU3luYyhkaXJQYXRoLCB7IHdpdGhGaWxlVHlwZXM6IHRydWUgfSk7XG4gIGZvciAoY29uc3QgZCBvZiBkaXJlY3RvcnkpIHtcbiAgICBjb25zdCBmaWxlUGF0aCA9IHJlc29sdmVQYXRoKGRpclBhdGgsIGQubmFtZSk7XG4gICAgaWYgKGQuaXNEaXJlY3RvcnkoKSkge1xuICAgICAgZmlsZVBhdGhzLnB1c2goLi4ubGlzdEZpbGVQYXRocyhmaWxlUGF0aCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBmaWxlUGF0aHMucHVzaChmaWxlUGF0aCk7XG4gICAgfVxuICB9XG4gIHJldHVybiBmaWxlUGF0aHM7XG59XG5cbmZ1bmN0aW9uIHN1YnN0aXR1dGUoeyBmaWxlUGF0aHMsIGNvbmZpZyB9OiB7IGZpbGVQYXRoczogc3RyaW5nW107IGNvbmZpZzogUmVjb3JkPHN0cmluZywgc3RyaW5nPiB9KSB7XG4gIGNvbnN0IGZpbmRSZWdFeHAgPSBuZXcgUmVnRXhwKE9iamVjdC5rZXlzKGNvbmZpZykuam9pbignfCcpLCAnZycpO1xuICBmb3IgKGNvbnN0IGZpbGVQYXRoIG9mIGZpbGVQYXRocykge1xuICAgIGlmIChmaWxlUGF0aC5pbmNsdWRlcygnbm9kZV9tb2R1bGVzJykpIGNvbnRpbnVlO1xuICAgIGNvbnN0IGZpbGVDb250ZW50cyA9IHJlYWRGaWxlU3luYyhmaWxlUGF0aCwgeyBlbmNvZGluZzogJ3V0ZjgnIH0pO1xuICAgIGNvbnN0IG5ld0ZpbGVDb250ZW50cyA9IGZpbGVDb250ZW50cy5yZXBsYWNlKGZpbmRSZWdFeHAsIChtYXRjaGVkKSA9PiB7XG4gICAgICBjb25zdCBtYXRjaGVkRW52VmFyID0gY29uZmlnW21hdGNoZWRdO1xuICAgICAgaWYgKG1hdGNoZWRFbnZWYXIpIHtcbiAgICAgICAgcmV0dXJuIG1hdGNoZWRFbnZWYXI7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLndhcm4oYENvdWxkIG5vdCBmaW5kIG1hdGNoZWQgdmFsdWU6ICR7bWF0Y2hlZH0gaW4gZW52aXJvbm1lbnQgb2JqZWN0LiBTdWJzdGl0dXRpbmcgJydgKTtcbiAgICAgICAgcmV0dXJuICcnO1xuICAgICAgfVxuICAgIH0pO1xuICAgIGlmIChmaWxlQ29udGVudHMgIT09IG5ld0ZpbGVDb250ZW50cykge1xuICAgICAgd3JpdGVGaWxlU3luYyhmaWxlUGF0aCwgbmV3RmlsZUNvbnRlbnRzKTtcbiAgICB9XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gcHJ1bmVCdWNrZXQoeyBidWNrZXROYW1lLCBrZXlQcmVmaXggfTogeyBidWNrZXROYW1lOiBzdHJpbmc7IGtleVByZWZpeD86IHN0cmluZyB9KSB7XG4gIGNvbnN0IGRlbGV0ZU9iamVjdFByb21pc2VzOiBQcm9taXNlPHVua25vd24+W10gPSBbXTtcbiAgbGV0IG51bU9iamVjdHNEZWxldGVkID0gMDtcbiAgbGV0IG5leHRUb2tlbjogc3RyaW5nIHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkO1xuICBkbyB7XG4gICAgY29uc3QgY21kOiBMaXN0T2JqZWN0c1YyQ29tbWFuZElucHV0ID0geyBCdWNrZXQ6IGJ1Y2tldE5hbWUsIFByZWZpeDoga2V5UHJlZml4IH07XG4gICAgaWYgKG5leHRUb2tlbikge1xuICAgICAgY21kLkNvbnRpbnVhdGlvblRva2VuID0gbmV4dFRva2VuO1xuICAgIH1cbiAgICBjb25zdCByZXMgPSBhd2FpdCBzMy5zZW5kKG5ldyBMaXN0T2JqZWN0c1YyQ29tbWFuZChjbWQpKTtcbiAgICBjb25zdCBjb250ZW50cyA9IHJlcy5Db250ZW50cztcbiAgICBuZXh0VG9rZW4gPSByZXMuTmV4dENvbnRpbnVhdGlvblRva2VuO1xuICAgIGlmIChjb250ZW50cz8ubGVuZ3RoKSB7XG4gICAgICBjb25zdCBvYmplY3RzID0gY29udGVudHM/Lm1hcCgobykgPT4gKHsgS2V5OiBvLktleSB9KSk7XG4gICAgICBudW1PYmplY3RzRGVsZXRlZCArPSBvYmplY3RzPy5sZW5ndGg7XG4gICAgICBkZWxldGVPYmplY3RQcm9taXNlcy5wdXNoKFxuICAgICAgICBzMy5zZW5kKFxuICAgICAgICAgIG5ldyBEZWxldGVPYmplY3RzQ29tbWFuZCh7XG4gICAgICAgICAgICBCdWNrZXQ6IGJ1Y2tldE5hbWUsXG4gICAgICAgICAgICBEZWxldGU6IHsgT2JqZWN0czogb2JqZWN0cyB9LFxuICAgICAgICAgIH0pXG4gICAgICAgIClcbiAgICAgICk7XG4gICAgfVxuICB9IHdoaWxlIChuZXh0VG9rZW4pO1xuICBhd2FpdCBQcm9taXNlLmFsbChkZWxldGVPYmplY3RQcm9taXNlcyk7XG4gIGNvbnNvbGUubG9nKGBOdW1iZXIgb2Ygb2JqZWN0cyBkZWxldGVkIGZvciBidWNrZXQgJHtidWNrZXROYW1lfTogJHtudW1PYmplY3RzRGVsZXRlZH1gKTtcbn1cblxuZnVuY3Rpb24gdXBsb2FkT2JqZWN0cyh7XG4gIGJ1Y2tldCxcbiAga2V5UHJlZml4LFxuICBmaWxlUGF0aHMsXG4gIHRtcERpcixcbiAgcHV0Q29uZmlnID0ge30sXG59OiB7XG4gIGJ1Y2tldDogQ3VzdG9tUmVzb3VyY2VQcm9wZXJ0aWVzWydkZXN0aW5hdGlvbkJ1Y2tldE5hbWUnXTtcbiAga2V5UHJlZml4PzogQ3VzdG9tUmVzb3VyY2VQcm9wZXJ0aWVzWydkZXN0aW5hdGlvbktleVByZWZpeCddO1xuICBmaWxlUGF0aHM6IHN0cmluZ1tdO1xuICB0bXBEaXI6IHN0cmluZztcbiAgcHV0Q29uZmlnOiBDdXN0b21SZXNvdXJjZVByb3BlcnRpZXNbJ3B1dENvbmZpZyddO1xufSkge1xuICBjb25zdCBwdXRPYmplY3RJbnB1dHM6IFB1dE9iamVjdENvbW1hbmRJbnB1dFtdID0gZmlsZVBhdGhzLm1hcCgocGF0aCkgPT4ge1xuICAgIGNvbnN0IGNvbnRlbnRUeXBlID0gbWltZS5sb29rdXAocGF0aCkgfHwgdW5kZWZpbmVkO1xuICAgIGNvbnN0IHB1dE9iamVjdE9wdGlvbnMgPSBnZXRQdXRPYmplY3RPcHRpb25zKHsgcGF0aCwgcHV0Q29uZmlnIH0pO1xuICAgIGNvbnN0IGtleVBhdGhzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGlmIChrZXlQcmVmaXgpIGtleVBhdGhzLnB1c2goa2V5UHJlZml4KTtcbiAgICBrZXlQYXRocy5wdXNoKHJlbGF0aXZlKHRtcERpciwgcGF0aCkpO1xuICAgIHJldHVybiB7XG4gICAgICBDb250ZW50VHlwZTogY29udGVudFR5cGUsXG4gICAgICAuLi5wdXRPYmplY3RPcHRpb25zLFxuICAgICAgQnVja2V0OiBidWNrZXQsXG4gICAgICAvLyAuc2xpY2UoMSkgdG8gcmVtb3ZlIGxlYWRpbmcgc2xhc2ggYi9jIHMzIHdpbGwgY3JlYXRlIHRvcCBsZXZlbCAvIGZvbGRlclxuICAgICAgS2V5OiBqb2luKC4uLmtleVBhdGhzKSxcbiAgICAgIEJvZHk6IGNyZWF0ZVJlYWRTdHJlYW0ocGF0aCksXG4gICAgfTtcbiAgfSk7XG4gIHJldHVybiBQcm9taXNlLmFsbChwdXRPYmplY3RJbnB1dHMubWFwKChpbnB1dCkgPT4gczMuc2VuZChuZXcgUHV0T2JqZWN0Q29tbWFuZChpbnB1dCkpKSk7XG59XG5cbi8qKlxuICogWmlwcyBvYmplY3RzIHRha2luZyBpbnRvIGFjY291bnQgc3ltbGlua3NcbiAqIEBzZWUgaHR0cHM6Ly9naXRodWIuY29tL1N0dWsvanN6aXAvaXNzdWVzLzM4NiNpc3N1ZWNvbW1lbnQtNjM0NzczMzQzXG4gKi9cbmZ1bmN0aW9uIHppcE9iamVjdHMoeyB0bXBEaXIgfTogeyB0bXBEaXI6IHN0cmluZyB9KTogUHJvbWlzZTxCdWZmZXI+IHtcbiAgY29uc3QgemlwID0gbmV3IEpTWmlwKCk7XG4gIGNvbnN0IGZpbGVQYXRocyA9IGxpc3RGaWxlUGF0aHModG1wRGlyKTtcbiAgZm9yIChjb25zdCBmaWxlUGF0aCBvZiBmaWxlUGF0aHMpIHtcbiAgICBjb25zdCByZWxhdGl2ZVBhdGggPSByZWxhdGl2ZSh0bXBEaXIsIGZpbGVQYXRoKTtcbiAgICBjb25zdCBzdGF0ID0gbHN0YXRTeW5jKGZpbGVQYXRoKTtcbiAgICBpZiAoc3RhdC5pc1N5bWJvbGljTGluaygpKSB7XG4gICAgICB6aXAuZmlsZShyZWxhdGl2ZVBhdGgsIHJlYWRsaW5rU3luYyhmaWxlUGF0aCksIHtcbiAgICAgICAgZGlyOiBzdGF0LmlzRGlyZWN0b3J5KCksXG4gICAgICAgIHVuaXhQZXJtaXNzaW9uczogcGFyc2VJbnQoJzEyMDc1NScsIDgpLFxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHppcC5maWxlKHJlbGF0aXZlUGF0aCwgcmVhZEZpbGVTeW5jKGZpbGVQYXRoKSwgeyBkaXI6IHN0YXQuaXNEaXJlY3RvcnkoKSwgdW5peFBlcm1pc3Npb25zOiBzdGF0Lm1vZGUgfSk7XG4gICAgfVxuICB9XG4gIHJldHVybiB6aXAuZ2VuZXJhdGVBc3luYyh7XG4gICAgdHlwZTogJ25vZGVidWZmZXInLFxuICAgIHBsYXRmb3JtOiAnVU5JWCcsXG4gICAgY29tcHJlc3Npb246ICdTVE9SRScsXG4gIH0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiB1cGxvYWRaaXAoe1xuICBidWNrZXQsXG4gIGtleVByZWZpeCxcbiAgemlwQnVmZmVyLFxufToge1xuICBidWNrZXQ6IEN1c3RvbVJlc291cmNlUHJvcGVydGllc1snZGVzdGluYXRpb25CdWNrZXROYW1lJ107XG4gIGtleVByZWZpeD86IEN1c3RvbVJlc291cmNlUHJvcGVydGllc1snZGVzdGluYXRpb25LZXlQcmVmaXgnXTtcbiAgemlwQnVmZmVyOiBCdWZmZXI7XG59KSB7XG4gIHJldHVybiBzMy5zZW5kKFxuICAgIG5ldyBQdXRPYmplY3RDb21tYW5kKHtcbiAgICAgIEJ1Y2tldDogYnVja2V0LFxuICAgICAgS2V5OiBrZXlQcmVmaXgsXG4gICAgICBCb2R5OiB6aXBCdWZmZXIsXG4gICAgICBDb250ZW50VHlwZTogJ2FwcGxpY2F0aW9uL3ppcCcsXG4gICAgfSlcbiAgKTtcbn1cblxuZnVuY3Rpb24gZ2V0UHV0T2JqZWN0T3B0aW9ucyh7XG4gIHBhdGgsXG4gIHB1dENvbmZpZyA9IHt9LFxufToge1xuICBwYXRoOiBzdHJpbmc7XG4gIHB1dENvbmZpZzogTmV4dGpzQnVja2V0RGVwbG95bWVudFByb3BzWydwdXRDb25maWcnXTtcbn0pOiBQYXJ0aWFsPFB1dE9iamVjdENvbW1hbmRJbnB1dD4ge1xuICBsZXQgcHV0T2JqZWN0T3B0aW9uczogUGFydGlhbDxQdXRPYmplY3RDb21tYW5kSW5wdXQ+ID0ge307XG4gIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHB1dENvbmZpZykpIHtcbiAgICBpZiAobWljcm9tYXRjaC5pc01hdGNoKHBhdGgsIGtleSkpIHtcbiAgICAgIHB1dE9iamVjdE9wdGlvbnMgPSB7IC4uLnB1dE9iamVjdE9wdGlvbnMsIC4uLnZhbHVlIH07XG4gICAgfVxuICB9XG4gIHJldHVybiBwdXRPYmplY3RPcHRpb25zO1xufVxuXG5pbnRlcmZhY2UgQ2ZuUmVzcG9uc2VQcm9wcyB7XG4gIGV2ZW50OiBQYXJhbWV0ZXJzPENsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VIYW5kbGVyPlswXTtcbiAgY29udGV4dDogUGFyYW1ldGVyczxDbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlSGFuZGxlcj5bMV07XG4gIHJlc3BvbnNlU3RhdHVzOiAnU1VDQ0VTUycgfCAnRkFJTEVEJztcbiAgcmVzcG9uc2VEYXRhPzogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcbiAgcGh5c2ljYWxSZXNvdXJjZUlkPzogc3RyaW5nO1xufVxuLyoqXG4gKiBJbnNwaXJlZCBieTogaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL0FXU0Nsb3VkRm9ybWF0aW9uL2xhdGVzdC9Vc2VyR3VpZGUvY2ZuLWxhbWJkYS1mdW5jdGlvbi1jb2RlLWNmbnJlc3BvbnNlbW9kdWxlLmh0bWxcbiAqL1xuZnVuY3Rpb24gY2ZuUmVzcG9uc2UocHJvcHM6IENmblJlc3BvbnNlUHJvcHMpIHtcbiAgY29uc3QgYm9keSA9IEpTT04uc3RyaW5naWZ5KHtcbiAgICBTdGF0dXM6IHByb3BzLnJlc3BvbnNlU3RhdHVzLFxuICAgIFJlYXNvbjogJ1NlZSB0aGUgZGV0YWlscyBpbiBDbG91ZFdhdGNoIExvZyBTdHJlYW06ICcgKyBwcm9wcy5jb250ZXh0LmxvZ1N0cmVhbU5hbWUsXG4gICAgUGh5c2ljYWxSZXNvdXJjZUlkOiBwcm9wcy5waHlzaWNhbFJlc291cmNlSWQgfHwgcHJvcHMuY29udGV4dC5sb2dTdHJlYW1OYW1lLFxuICAgIFN0YWNrSWQ6IHByb3BzLmV2ZW50LlN0YWNrSWQsXG4gICAgUmVxdWVzdElkOiBwcm9wcy5ldmVudC5SZXF1ZXN0SWQsXG4gICAgTG9naWNhbFJlc291cmNlSWQ6IHByb3BzLmV2ZW50LkxvZ2ljYWxSZXNvdXJjZUlkLFxuICAgIERhdGE6IHByb3BzLnJlc3BvbnNlRGF0YSxcbiAgfSk7XG4gIHJldHVybiBmZXRjaChwcm9wcy5ldmVudC5SZXNwb25zZVVSTCwge1xuICAgIG1ldGhvZDogJ1BVVCcsXG4gICAgYm9keSxcbiAgICBoZWFkZXJzOiB7ICdjb250ZW50LXR5cGUnOiAnJywgJ2NvbnRlbnQtbGVuZ3RoJzogYm9keS5sZW5ndGgudG9TdHJpbmcoKSB9LFxuICB9KTtcbn1cbiJdfQ==