"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.NextjsBucketDeployment = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const path = require("node:path");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_lambda_1 = require("aws-cdk-lib/aws-lambda");
const constructs_1 = require("constructs");
const common_lambda_props_1 = require("./utils/common-lambda-props");
/**
 * Similar to CDK's `BucketDeployment` construct, but with a focus on replacing
 * template placeholders (i.e. environment variables) and configuring PUT
 * options like cache control.
 */
class NextjsBucketDeployment extends constructs_1.Construct {
    /**
     * Formats a string as a template value so custom resource knows to replace.
     */
    static getSubstitutionValue(v) {
        return `{{ ${v} }}`;
    }
    /**
     * Creates `substitutionConfig` an object by extracting unresolved tokens.
     */
    static getSubstitutionConfig(env) {
        const substitutionConfig = {};
        for (const [k, v] of Object.entries(env)) {
            if (aws_cdk_lib_1.Token.isUnresolved(v)) {
                substitutionConfig[NextjsBucketDeployment.getSubstitutionValue(k)] = v;
            }
        }
        return substitutionConfig;
    }
    constructor(scope, id, props) {
        super(scope, id);
        this.props = props;
        this.function = this.createFunction();
        this.createCustomResource(this.function.functionArn);
    }
    createFunction() {
        const fn = new aws_lambda_1.Function(this, 'Fn', {
            ...(0, common_lambda_props_1.getCommonFunctionProps)(this),
            code: aws_lambda_1.Code.fromAsset(path.resolve(__dirname, '..', 'assets', 'lambdas', 'nextjs-bucket-deployment')),
            handler: 'index.handler',
            timeout: aws_cdk_lib_1.Duration.minutes(5),
        });
        if (this.props.debug) {
            fn.addEnvironment('DEBUG', '1');
        }
        this.props.asset.grantRead(fn);
        this.props.destinationBucket.grantReadWrite(fn);
        return fn;
    }
    createCustomResource(serviceToken) {
        const properties = {
            sourceBucketName: this.props.asset.s3BucketName,
            sourceKeyPrefix: this.props.asset.s3ObjectKey,
            destinationBucketName: this.props.destinationBucket.bucketName,
            destinationKeyPrefix: this.props.destinationKeyPrefix,
            putConfig: this.props.putConfig,
            prune: this.props.prune,
            substitutionConfig: this.props.substitutionConfig,
            zip: this.props.zip,
        };
        return new aws_cdk_lib_1.CustomResource(this, 'CustomResource', {
            properties,
            resourceType: 'Custom::NextjsBucketDeployment',
            serviceToken,
        });
    }
}
_a = JSII_RTTI_SYMBOL_1;
NextjsBucketDeployment[_a] = { fqn: "cdk-nextjs-standalone.NextjsBucketDeployment", version: "0.0.0" };
exports.NextjsBucketDeployment = NextjsBucketDeployment;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTmV4dGpzQnVja2V0RGVwbG95bWVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9OZXh0anNCdWNrZXREZXBsb3ltZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsa0NBQWtDO0FBQ2xDLDZDQUE4RDtBQUM5RCx1REFBd0Q7QUFHeEQsMkNBQXVDO0FBQ3ZDLHFFQUFxRTtBQWlFckU7Ozs7R0FJRztBQUNILE1BQWEsc0JBQXVCLFNBQVEsc0JBQVM7SUFDbkQ7O09BRUc7SUFDSCxNQUFNLENBQUMsb0JBQW9CLENBQUMsQ0FBUztRQUNuQyxPQUFPLE1BQU0sQ0FBQyxLQUFLLENBQUM7SUFDdEIsQ0FBQztJQUNEOztPQUVHO0lBQ0gsTUFBTSxDQUFDLHFCQUFxQixDQUFDLEdBQTJCO1FBQ3RELE1BQU0sa0JBQWtCLEdBQTJCLEVBQUUsQ0FBQztRQUN0RCxLQUFLLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUN4QyxJQUFJLG1CQUFLLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxFQUFFO2dCQUN6QixrQkFBa0IsQ0FBQyxzQkFBc0IsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUN4RTtTQUNGO1FBQ0QsT0FBTyxrQkFBa0IsQ0FBQztJQUM1QixDQUFDO0lBT0QsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUFrQztRQUMxRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ2pCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ3RDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQ3ZELENBQUM7SUFFTyxjQUFjO1FBQ3BCLE1BQU0sRUFBRSxHQUFHLElBQUkscUJBQVEsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFO1lBQ2xDLEdBQUcsSUFBQSw0Q0FBc0IsRUFBQyxJQUFJLENBQUM7WUFDL0IsSUFBSSxFQUFFLGlCQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLDBCQUEwQixDQUFDLENBQUM7WUFDcEcsT0FBTyxFQUFFLGVBQWU7WUFDeEIsT0FBTyxFQUFFLHNCQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztTQUM3QixDQUFDLENBQUM7UUFDSCxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFO1lBQ3BCLEVBQUUsQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1NBQ2pDO1FBQ0QsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQy9CLElBQUksQ0FBQyxLQUFLLENBQUMsaUJBQWlCLENBQUMsY0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ2hELE9BQU8sRUFBRSxDQUFDO0lBQ1osQ0FBQztJQUVPLG9CQUFvQixDQUFDLFlBQW9CO1FBQy9DLE1BQU0sVUFBVSxHQUE2QjtZQUMzQyxnQkFBZ0IsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxZQUFZO1lBQy9DLGVBQWUsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxXQUFXO1lBQzdDLHFCQUFxQixFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsaUJBQWlCLENBQUMsVUFBVTtZQUM5RCxvQkFBb0IsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLG9CQUFvQjtZQUNyRCxTQUFTLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTO1lBQy9CLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUs7WUFDdkIsa0JBQWtCLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxrQkFBa0I7WUFDakQsR0FBRyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRztTQUNwQixDQUFDO1FBQ0YsT0FBTyxJQUFJLDRCQUFjLENBQUMsSUFBSSxFQUFFLGdCQUFnQixFQUFFO1lBQ2hELFVBQVU7WUFDVixZQUFZLEVBQUUsZ0NBQWdDO1lBQzlDLFlBQVk7U0FDYixDQUFDLENBQUM7SUFDTCxDQUFDOzs7O0FBL0RVLHdEQUFzQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHBhdGggZnJvbSAnbm9kZTpwYXRoJztcbmltcG9ydCB7IEN1c3RvbVJlc291cmNlLCBEdXJhdGlvbiwgVG9rZW4gfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgeyBDb2RlLCBGdW5jdGlvbiB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgSUJ1Y2tldCB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1zMyc7XG5pbXBvcnQgeyBBc3NldCB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1zMy1hc3NldHMnO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgeyBnZXRDb21tb25GdW5jdGlvblByb3BzIH0gZnJvbSAnLi91dGlscy9jb21tb24tbGFtYmRhLXByb3BzJztcblxuZXhwb3J0IGludGVyZmFjZSBOZXh0anNCdWNrZXREZXBsb3ltZW50UHJvcHMge1xuICAvKipcbiAgICogU291cmNlIGBBc3NldGBcbiAgICovXG4gIHJlYWRvbmx5IGFzc2V0OiBBc3NldDtcbiAgLyoqXG4gICAqIEVuYWJsZSB2ZXJib3NlIG91dHB1dCBvZiBDdXN0b20gUmVzb3VyY2UgTGFtYmRhXG4gICAqIEBkZWZhdWx0IGZhbHNlXG4gICAqL1xuICByZWFkb25seSBkZWJ1Zz86IGJvb2xlYW4gfCB1bmRlZmluZWQ7XG4gIC8qKlxuICAgKiBJZiBgdHJ1ZWAsIHRoZW4gZGVsZXRlIGZpbGVzIGluIGBkZXN0aW5hdGlvbkJ1Y2tldGAvYGRlc3RpbmF0aW9uS2V5UHJlZml4YFxuICAgKiBiZWZvcmUgdXBsb2FkaW5nIG5ldyBvYmplY3RzXG4gICAqIEBkZWZhdWx0IHRydWVcbiAgICovXG4gIHJlYWRvbmx5IHBydW5lPzogYm9vbGVhbiB8IHVuZGVmaW5lZDtcbiAgLyoqXG4gICAqIE1hcHBpbmcgb2YgZmlsZXMgdG8gUFVUIG9wdGlvbnMgZm9yIGBQdXRPYmplY3RDb21tYW5kYC4gS2V5cyBvZlxuICAgKiByZWNvcmQgbXVzdCBiZSBhIGdsb2IgcGF0dGVybiAodXNlcyBtaWNyb21hdGNoKS4gVmFsdWVzIG9mIHJlY29yZCBhcmUgb3B0aW9uc1xuICAgKiBmb3IgUFVUIGNvbW1hbmQgZm9yIEFXUyBTREsgSlMgVjMuIFNlZSBbaGVyZV0oaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL0FXU0phdmFTY3JpcHRTREsvdjMvbGF0ZXN0L1BhY2thZ2UvLWF3cy1zZGstY2xpZW50LXMzL0ludGVyZmFjZS9QdXRPYmplY3RSZXF1ZXN0LylcbiAgICogZm9yIG9wdGlvbnMuIElmIGEgZmlsZSBtYXRjaGVzIG11bHRpcGxlIGdsb2JzLCBjb25maWd1cmF0aW9uIHdpbGwgYmVcbiAgICogbWVyZ2VkLiBMYXRlciBlbnRyaWVzIG92ZXJyaWRlIGVhcmxpZXIgZW50cmllcy5cbiAgICpcbiAgICogYEJ1Y2tldGAsIGBLZXlgLCBhbmQgYEJvZHlgIFBVVCBvcHRpb25zIGNhbm5vdCBiZSBzZXQuXG4gICAqL1xuICByZWFkb25seSBwdXRDb25maWc/OiBSZWNvcmQ8c3RyaW5nLCBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+PjtcbiAgLyoqXG4gICAqIERlc3RpbmF0aW9uIFMzIEJ1Y2tldFxuICAgKi9cbiAgcmVhZG9ubHkgZGVzdGluYXRpb25CdWNrZXQ6IElCdWNrZXQ7XG4gIC8qKlxuICAgKiBEZXN0aW5hdGlvbiBTMyBCdWNrZXQgS2V5IFByZWZpeFxuICAgKi9cbiAgcmVhZG9ubHkgZGVzdGluYXRpb25LZXlQcmVmaXg/OiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIC8qKlxuICAgKiBSZXBsYWNlIHBsYWNlaG9sZGVycyBpbiBhbGwgZmlsZXMgaW4gYGFzc2V0YC4gUGxhY2Vob2xkZXIgdGFyZ2V0cyBhcmVcbiAgICogZGVmaW5lZCBieSBrZXlzIG9mIHJlY29yZC4gVmFsdWVzIHRvIHJlcGxhY2UgcGxhY2Vob2xkZXJzIHdpdGggYXJlIGRlZmluZWRcbiAgICogYnkgdmFsdWVzIG9mIHJlY29yZC5cbiAgICovXG4gIHJlYWRvbmx5IHN1YnN0aXR1dGlvbkNvbmZpZz86IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG4gIC8qKlxuICAgKiBJZiBgdHJ1ZWAgdGhlbiBmaWxlcyB3aWxsIGJlIHppcHBlZCBiZWZvcmUgd3JpdGluZyB0byBkZXN0aW5hdGlvbiBidWNrZXQuXG4gICAqXG4gICAqIFVzZWZ1bCBmb3IgTGFtYmRhIGZ1bmN0aW9ucy5cbiAgICogQGRlZmF1bHQgZmFsc2VcbiAgICovXG4gIHJlYWRvbmx5IHppcD86IGJvb2xlYW4gfCB1bmRlZmluZWQ7XG59XG5cbi8qKlxuICogQGludGVybmFsXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQ3VzdG9tUmVzb3VyY2VQcm9wZXJ0aWVzIHtcbiAgZGVzdGluYXRpb25CdWNrZXROYW1lOiBzdHJpbmc7XG4gIGRlc3RpbmF0aW9uS2V5UHJlZml4Pzogc3RyaW5nO1xuICBwcnVuZT86IGJvb2xlYW4gfCB1bmRlZmluZWQ7XG4gIHB1dENvbmZpZz86IE5leHRqc0J1Y2tldERlcGxveW1lbnRQcm9wc1sncHV0Q29uZmlnJ107XG4gIHN1YnN0aXR1dGlvbkNvbmZpZz86IE5leHRqc0J1Y2tldERlcGxveW1lbnRQcm9wc1snc3Vic3RpdHV0aW9uQ29uZmlnJ107XG4gIHNvdXJjZUJ1Y2tldE5hbWU6IHN0cmluZztcbiAgc291cmNlS2V5UHJlZml4Pzogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICB6aXA/OiBib29sZWFuIHwgdW5kZWZpbmVkO1xufVxuXG4vKipcbiAqIFNpbWlsYXIgdG8gQ0RLJ3MgYEJ1Y2tldERlcGxveW1lbnRgIGNvbnN0cnVjdCwgYnV0IHdpdGggYSBmb2N1cyBvbiByZXBsYWNpbmdcbiAqIHRlbXBsYXRlIHBsYWNlaG9sZGVycyAoaS5lLiBlbnZpcm9ubWVudCB2YXJpYWJsZXMpIGFuZCBjb25maWd1cmluZyBQVVRcbiAqIG9wdGlvbnMgbGlrZSBjYWNoZSBjb250cm9sLlxuICovXG5leHBvcnQgY2xhc3MgTmV4dGpzQnVja2V0RGVwbG95bWVudCBleHRlbmRzIENvbnN0cnVjdCB7XG4gIC8qKlxuICAgKiBGb3JtYXRzIGEgc3RyaW5nIGFzIGEgdGVtcGxhdGUgdmFsdWUgc28gY3VzdG9tIHJlc291cmNlIGtub3dzIHRvIHJlcGxhY2UuXG4gICAqL1xuICBzdGF0aWMgZ2V0U3Vic3RpdHV0aW9uVmFsdWUodjogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYHt7ICR7dn0gfX1gO1xuICB9XG4gIC8qKlxuICAgKiBDcmVhdGVzIGBzdWJzdGl0dXRpb25Db25maWdgIGFuIG9iamVjdCBieSBleHRyYWN0aW5nIHVucmVzb2x2ZWQgdG9rZW5zLlxuICAgKi9cbiAgc3RhdGljIGdldFN1YnN0aXR1dGlvbkNvbmZpZyhlbnY6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4pOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+IHtcbiAgICBjb25zdCBzdWJzdGl0dXRpb25Db25maWc6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7fTtcbiAgICBmb3IgKGNvbnN0IFtrLCB2XSBvZiBPYmplY3QuZW50cmllcyhlbnYpKSB7XG4gICAgICBpZiAoVG9rZW4uaXNVbnJlc29sdmVkKHYpKSB7XG4gICAgICAgIHN1YnN0aXR1dGlvbkNvbmZpZ1tOZXh0anNCdWNrZXREZXBsb3ltZW50LmdldFN1YnN0aXR1dGlvblZhbHVlKGspXSA9IHY7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBzdWJzdGl0dXRpb25Db25maWc7XG4gIH1cbiAgLyoqXG4gICAqIExhbWJkYSBGdW5jdGlvbiBQcm92aWRlciBmb3IgQ3VzdG9tIFJlc291cmNlXG4gICAqL1xuICBmdW5jdGlvbjogRnVuY3Rpb247XG4gIHByaXZhdGUgcHJvcHM6IE5leHRqc0J1Y2tldERlcGxveW1lbnRQcm9wcztcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogTmV4dGpzQnVja2V0RGVwbG95bWVudFByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcbiAgICB0aGlzLnByb3BzID0gcHJvcHM7XG4gICAgdGhpcy5mdW5jdGlvbiA9IHRoaXMuY3JlYXRlRnVuY3Rpb24oKTtcbiAgICB0aGlzLmNyZWF0ZUN1c3RvbVJlc291cmNlKHRoaXMuZnVuY3Rpb24uZnVuY3Rpb25Bcm4pO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVGdW5jdGlvbigpIHtcbiAgICBjb25zdCBmbiA9IG5ldyBGdW5jdGlvbih0aGlzLCAnRm4nLCB7XG4gICAgICAuLi5nZXRDb21tb25GdW5jdGlvblByb3BzKHRoaXMpLFxuICAgICAgY29kZTogQ29kZS5mcm9tQXNzZXQocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJ2Fzc2V0cycsICdsYW1iZGFzJywgJ25leHRqcy1idWNrZXQtZGVwbG95bWVudCcpKSxcbiAgICAgIGhhbmRsZXI6ICdpbmRleC5oYW5kbGVyJyxcbiAgICAgIHRpbWVvdXQ6IER1cmF0aW9uLm1pbnV0ZXMoNSksXG4gICAgfSk7XG4gICAgaWYgKHRoaXMucHJvcHMuZGVidWcpIHtcbiAgICAgIGZuLmFkZEVudmlyb25tZW50KCdERUJVRycsICcxJyk7XG4gICAgfVxuICAgIHRoaXMucHJvcHMuYXNzZXQuZ3JhbnRSZWFkKGZuKTtcbiAgICB0aGlzLnByb3BzLmRlc3RpbmF0aW9uQnVja2V0LmdyYW50UmVhZFdyaXRlKGZuKTtcbiAgICByZXR1cm4gZm47XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUN1c3RvbVJlc291cmNlKHNlcnZpY2VUb2tlbjogc3RyaW5nKSB7XG4gICAgY29uc3QgcHJvcGVydGllczogQ3VzdG9tUmVzb3VyY2VQcm9wZXJ0aWVzID0ge1xuICAgICAgc291cmNlQnVja2V0TmFtZTogdGhpcy5wcm9wcy5hc3NldC5zM0J1Y2tldE5hbWUsXG4gICAgICBzb3VyY2VLZXlQcmVmaXg6IHRoaXMucHJvcHMuYXNzZXQuczNPYmplY3RLZXksXG4gICAgICBkZXN0aW5hdGlvbkJ1Y2tldE5hbWU6IHRoaXMucHJvcHMuZGVzdGluYXRpb25CdWNrZXQuYnVja2V0TmFtZSxcbiAgICAgIGRlc3RpbmF0aW9uS2V5UHJlZml4OiB0aGlzLnByb3BzLmRlc3RpbmF0aW9uS2V5UHJlZml4LFxuICAgICAgcHV0Q29uZmlnOiB0aGlzLnByb3BzLnB1dENvbmZpZyxcbiAgICAgIHBydW5lOiB0aGlzLnByb3BzLnBydW5lLFxuICAgICAgc3Vic3RpdHV0aW9uQ29uZmlnOiB0aGlzLnByb3BzLnN1YnN0aXR1dGlvbkNvbmZpZyxcbiAgICAgIHppcDogdGhpcy5wcm9wcy56aXAsXG4gICAgfTtcbiAgICByZXR1cm4gbmV3IEN1c3RvbVJlc291cmNlKHRoaXMsICdDdXN0b21SZXNvdXJjZScsIHtcbiAgICAgIHByb3BlcnRpZXMsXG4gICAgICByZXNvdXJjZVR5cGU6ICdDdXN0b206Ok5leHRqc0J1Y2tldERlcGxveW1lbnQnLFxuICAgICAgc2VydmljZVRva2VuLFxuICAgIH0pO1xuICB9XG59XG4iXX0=